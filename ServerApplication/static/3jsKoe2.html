
<html>
  <head>
    <title>Three.js kokeilu</title>
    <!--style>canvas { width: 800px; height: 600px; }</style-->
    <style>body { width: 100%; height: 100%; padding: 0; margin: 0; }</style>
  </head>
  <body id="container">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="three.js"></script>
    <script src="stats.min.js"></script>
    <script>
        var container = document.getElementById('container');

        var stats = new Stats();
        stats.domElement.style.position = 'absolute';
        container.appendChild(stats.domElement);

        var renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setClearColor(0x335577);
        renderer.setSize(800, 600);
        container.appendChild(renderer.domElement);
        
        var scene = new THREE.Scene();
        var sceneBoundingBox = new THREE.Box3();

        var camera = new THREE.PerspectiveCamera(75, 800 / 600, 0.1, 100);
        var cameraControlPoint = new THREE.Vector3(0.0, 4.5, 0.0);
        
        //var lambertMaterial = new THREE.MeshLambertMaterial( { color: 0x777777 } );
        
        var ambientLight = new THREE.AmbientLight(0x080C10);
        scene.add(ambientLight);
        
        var directionalLight1 = new THREE.DirectionalLight(0xFFD0D0, 1.0);
        directionalLight1.position.set(1.0, 1.0, -1.0);
        scene.add(directionalLight1);
        
        var directionalLight2 = new THREE.DirectionalLight(0xD0D0FF, 1.0);
        directionalLight2.position.set(-1.0, 1.0, 1.0);
        scene.add(directionalLight2);
        
        onResize();
        window.addEventListener('resize', onResize, false);
        
        function onResize(event) {
            var rect = container.getBoundingClientRect();
            var screenW = rect.width;
            var screenH = rect.height;
            renderer.setSize(screenW, screenH);
            camera.aspect = screenW / screenH;
            camera.updateProjectionMatrix();
        }

        var render = function () {
            requestAnimationFrame(render);
            controlsUpdate();
            renderer.render(scene, camera);
            stats.update();
        };

        function mapDataLoaded(mapData) {
            //console.log(mapData);
            var loader = new THREE.JSONLoader;
            for (var index in mapData) {
                country = mapData[index];
                var name = country[0];
                var data = country[1];
                console.log(data);
                var geometry = loader.parse(data, "").geometry;
                geometry.computeBoundingBox();
                sceneBoundingBox.union(geometry.boundingBox);
                var rn = Math.random();
                //var c = 0xFFFFFF*rn;
                var rb = 0x33 * (1.0 - rn);
                var g = 0x33 + 0x99 * rn;
                var c = (rb << 16) | (g << 8) | rb;
                var maetrial = new THREE.MeshLambertMaterial( { color: c } );
                var mesh = new THREE.Mesh(geometry, maetrial);
                mesh.scale.y = rn;//Math.random();
                mesh.updateMatrix();
                scene.add(mesh);
            }
            sceneBoundingBox.min.y = 1.2;
            sceneBoundingBox.max.y = 5.0;
            
            render();
        }

        $.getJSON('/_map_data', {}, mapDataLoaded);
        
        // --- Controls ---
        
        var mouseMode = -1;
        var mouseStart = new THREE.Vector2();
        var mouseEnd = new THREE.Vector2();
        
        function controlsUpdate() {
            var mouseChange = new THREE.Vector2();
            mouseChange.copy(mouseEnd).sub(mouseStart);
            
            camera.rotation.x = -3.14 * 0.5;
            camera.rotation.y = 0.0;
            camera.rotation.z = 0.0;
                
            switch (mouseMode) {
                case 0: // Left button - Drag
                cameraControlPoint.x -= mouseChange.x * cameraControlPoint.y;
                cameraControlPoint.z -= mouseChange.y * cameraControlPoint.y;
                break;
                
                case 1: // Middle button - Zoom
                cameraControlPoint.y += mouseChange.y * cameraControlPoint.y;
                break;
                
                case 2: // Right button - Rotate
                camera.rotation.x -= mouseChange.y * 3.14 * 0.75;
                camera.rotation.y = -mouseChange.x * 3.14 * 0.75;
                break;
            }
            
            sceneBoundingBox.clampPoint(cameraControlPoint, cameraControlPoint);
            camera.position.copy(cameraControlPoint)
            camera.position.y = 0.5;
            camera.position.add(camera.getWorldDirection().multiplyScalar(-cameraControlPoint.y));
            
            if (mouseMode != 2)
                mouseStart.copy(mouseEnd);
        }
        
        function getMouseOnElement(elem, pageX, pageY) {
            var rect = elem.getBoundingClientRect();
            return new THREE.Vector2(
                (pageX - rect.left) / rect.width,
                (pageY - rect.top) / rect.height
            );
        }

        function mouseDown(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (mouseMode >= 0)
                return;
            
            mouseMode = event.button;
            
            mouseStart.copy(getMouseOnElement(renderer.domElement, event.pageX, event.pageY));
            mouseEnd.copy(mouseStart);
            
            renderer.domElement.addEventListener('mousemove', mouseMove, false);
            renderer.domElement.addEventListener('mouseup', mouseUp, false);
        }
        
        function mouseMove(event) {
            event.preventDefault();
            event.stopPropagation();
            
            mouseEnd.copy(getMouseOnElement(renderer.domElement, event.pageX, event.pageY));
        }
        
        function mouseUp(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (event.button != mouseMode)
                return;
            
            mouseMode = -1;
            
            mouseEnd.copy(mouseStart);
            
            renderer.domElement.removeEventListener('mousemove', mouseMove);
            renderer.domElement.removeEventListener('mouseup', mouseUp);
        }
        
        renderer.domElement.addEventListener('contextmenu', function (event) { event.preventDefault(); }, false);
        renderer.domElement.addEventListener('mousedown', mouseDown, false);
  </script>

  </body>
</html>
