{% extends "header.html" %}
{% block body %}
<div>
    <div class="row">
        <div class="col-md-1">Color:</div>
        <div class="col-md-1">
            <div class ="btn-group"><a id="color" class="btn btn-default dropdown-toggle btn-color" data-toggle="dropdown" href="#">Select dataset <span class="caret"></span></a>
                <ul class="dropdown-menu color-dropdown">
                    {% for query in queries %}
                    <li><a href="#" data-value="{{ query.id }}">{{ query.name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-md-1">
            <div class ="btn-group"><a id="color_parameters" class="btn btn-default dropdown-toggle btn-select2" data-toggle="dropdown" href="#">Parameters<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li><a href="#">Divided by population</a></li>
                    <li><a href="#">Divided by area</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-1">Min color</div>
        <div class="col-md-1">Max color</div>
        <div class="col-md-1">Max height: <span id="currentValue">1</span>
        </div>
    </div>
    <div class="row">
        <div class="col-md-1">Height:</div>
        <div class="col-md-1">
            <div class ="btn-group"><a class="btn btn-default dropdown-toggle btn-height" data-toggle="dropdown" href="#">Select dataset <span class="caret"></span></a>
                <ul class="dropdown-menu height-dropdown">
                    {% for query in queries %}
                    <li><a href="#" data-value="{{ query.id }}">{{ query.name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-md-1">
            <div class ="btn-group"><a class="btn btn-default dropdown-toggle btn-select4" data-toggle="dropdown" href="#">Parameters<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li><a href="#">Divided by population</a></li>
                    <li><a href="#">Divided by area</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-1">
            <input type='text' id="minColor"/>
        </div>
        <div class="col-md-1">
            <input type='text' id="maxColor"/>
        </div>
        <div class="col-md-1">
            <input type="range" id="slider" name="points" min="0.1" max="10" value="1" step="0.01">
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="mapdiv"></div>
        </div>
    </div>
</div>


<script type="text/javascript">
var map;
var color_selection;
var height_selection;

function onResize() {
    var container = document.getElementById('mapdiv');
    var rect = container.getBoundingClientRect();
    var ww = $(window).width();
    var wh = $(window).height();
    var w = (ww - rect.left - 10) + "px";
    var h = (wh - rect.top - 10) + "px";
    console.log(w, h);
    container.style.width = w;
    container.style.height = h;
    map.onResize();
}

$(document).ready(function () {
    var container = document.getElementById('mapdiv');
    map = new Map3D(container);
    map.setDefaultHeight(0.01);
    map.setHeightRange(0.05, 1.0);
    map.setDefaultColor(0x222222);
    colors_changed();

    $.getJSON('/_map_data', {},
        function (data) {
            //console.log(data);
            map.setMapData(data);
        });
    
    onResize();
    $('#mapdiv').resize(onResize);
});


var colors_changed = function(color) {
    var color_min = parseInt($('#minColor').spectrum("get").toHex(), 16);
    var color_max = parseInt($('#maxColor').spectrum("get").toHex(), 16);
    map.setColorRange(color_min, color_max);
    map.updateColors();
}

$(function(){
    var currentValue = $('#currentValue');
    $('#slider').change(function(){
        currentValue.html(this.value);
    });
        $('#slider').change();
});

$(".color-dropdown li a").click(function(){
  var selText = $(this).text();
  $(this).parents('.btn-group').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
  color_selection = $(this).attr('data-value');
  console.log(color_selection);
  send_query();
});

$(".height-dropdown li a").click(function(){
  var selText = $(this).text();
  $(this).parents('.btn-group').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
  height_selection = $(this).attr('data-value');
  console.log(height_selection);
  send_query();
});

$(function() {
  $('.btn-color').text().onchange = send_query();
  $('.btn-height').text().onchange = send_query();
});

var send_query = function() {

  $.getJSON("/_data", {
        color: color_selection,
        height: height_selection
    },
    function(data) {
        //console.log(data);
        map.setData(data);
    });
  return false;
};

var minColorPalette = {
    showPaletteOnly: true,
    togglePaletteOnly: true,
    togglePaletteMoreText: 'more',
    togglePaletteLessText: 'less',
    color: "#ff0",
    change: colors_changed,
    palette: [
        ["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
        ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
        ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
        ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
        ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
        ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
        ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]
    ]
}

$("#minColor").spectrum(
    minColorPalette
);

maxColorPalette = minColorPalette;
maxColorPalette.color = "#f00";

$("#maxColor").spectrum(
    maxColorPalette
);

</script>
{% endblock %}
